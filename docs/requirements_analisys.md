h2. Анализ требований и предварительные сценарии

Для простоты выделю три пункта, для которых будем проводить анализ требований.
1. Свет. Включение и выключение одного светового прибора по указанному времени. Настройка времени заложена пользователем и может меняться по его команде голосом или через смартфон. Вне расписания пользователь (домовладелец) может включить и выключить световой прибор голосом или физическим выключателем, или через смартфон в любое время дня и ночи. Также сценарий может быть отменён.
2. Температура. Здесь участвует два устройства: датчик температуры и кондиционер. Условия устанавливаются в приложении в смартфоне домовладельцем и могут быть изменены и вовсе отключены. Сигналы поступают от датчика, в зависимости от условий кондиционер включается и выключается. 
3. Настройки будильника в приложении и штор. Когда сработал будильник, шторы поднимаются. При этом опустить их можно в любое время через приложение или голосом

h3. Свет, сценарий, топики

Для домовладельца доступны две операции со световым прибором: изменение состояния (включение или выключение) и настройка расписания.

h4. Включение по команде

Команда от пользователя может поступить голосом или со смартфона. Замыкание элемктрической цепи (т.е. просто щёлкнуть выключателем) рассматривать не будем, т.к. при "умном" управлении цепь замыкается в самом приборе, например. То есть выключатель всегда находится в положении "Вкл"
1. Управление идёт со смартфона. Тогда пользователь нажимает в интерфейсе на условную кнопку включения. Данные передаются в сервис включения света. Сервис проверяет, не включен ли свет (топик /anyroom/light/floorlamp/status).
* Если не включен - изменить состояние (/anyroom/light/floorlamp/control)
* Если свет уже включен - состояние не изменять, отправить пользователю сообщение, что свет и так включен или выключен
* Если на каком-то этапе нет связи/возникла ошибка, сервис её обработает и вернёт сообщение пользователю
2. Управление идёт голосом
Логика управления будет той же и добавится сервис распознавания голосовых команд. Сервис универсальный, его можно переиспользовать и при других операциях (например, при включении кондиционера). Здесь важно обратить внимание, что для этого сервиса потребуется также хранилище формулировок команд.
* Если команда отличается от заданных для включения света, то процесс завершается
* Если команда не распознана, возвращаем ошибку
* Если команда дана верно, переходим к сервису включения света
sic! Здесь я не рассматриваю различные голоса (голосовой помощник может хуже реагировать на голос не домовладльца). В данном случае это не принципиально.

h4. Включение по расписанию

Расписание хранится в каком-либо хранилище. Оно так же, как и сервис распознавания команд, может быть общим для всего дома. Для проверки расписания также потребуется сервис, который будет инициировать команду включения/выключения света по расписанию. Также обращу внимание, что погрешность в виде минуты времени до/после включения мне не критична для реализации.

Предварительно для построения BPMN:
Старт процесса: инициирование процесса управления светом (т.е сигнал, что настало время включать свет) ИЛИ команда пользователя ИЛИ старт проверки расписания
Проверка расписания: сравнение текущего времени с заданным расписанием.
Распознавание голосовой команды
Включение/выключение света:
    Если время соответствует расписанию включения света, отправляется команда на включение света.
    Если время соответствует расписанию выключения света, отправляется команда на выключение света.

h4. Настройка расписания.

Настройка расписания пока ограничим только смартфоном (для простоты проекта). Настраивать расписание может администратор. В рамках одной квартиры роли домовладельца и администратора может выполнять один человек, но роли изначально необходимо разделить.

Сценарий настройки:
1. Пользователь заходит в приложение с ролью администратора
2. Открывает общее расписание, находит расписание для светового устройства. 
    2а. Есть вариант реализации, когда сначала выбираем устройство, потом - расписание.
3. Изменяет время для расписания и нажимает кнопку подтверждения
 3а. Возможно добавление пункта в расписание устройства. Тогда добавляем строку, подтверждаем условной кнопкой
4. Расписание обновляется.

Конец процесса: завершение процесса после выполнения команды или обновления расписания. 

h3. Регуляция температуры.

При регуляции температуры в комнате возможны следующие действия:
1. Включение/выключение кондиционера по сигналу, присланному датчиком темпераутры
2. Включение/выключение кондиционера по сигналу со смартфона ИЛИ по голосовой команде - в процессе пока не рассматриваю, поскольку работа идентична работе со светом.
3. Включение/выключение кондиционера по расписанию - не рассматриваю, поскольку работа идентична световому прибору. В реальной системе нужно было бы рассмотреть, но в примере усложнять не буду
4. Настройка граничных значений температуры для датчика.
5. Настройка расписания. Опять же - уже рассмотрено в световом приборе.

h4. Изменение состояния кондиционера (вкл/выкл) по сигналу с датчика.

1. Датчик регуярно отправляет данные о температуре в сервис (хранилище). Топик /anyroom/climate/temperature/*
2. Сервис проверяет значения (по-хорошему, нужно проверять минимум 2-3 значения подряд, чтобы избежать сбоев, случайных значений). 
    * Если температура выше заданной, проверить статус кондиционера (топик /anyroom/climate/conditioner/status). И если он не включен, включить (топик /anyroom/climate/conditioner/control)
    * Если тепература равна или ниже заданной, проверить статус кондиционера (топик /anyroom/climate/conditioner/status).  Если он включен, выключить (топик /anyroom/climate/conditioner/control)
3. В случае ошибок и /или потери связи вывести пользователю данные на смартфон. Топик

h4. Настройка граничного значения через смартфон

Настройкой граничных значений может заниматься домовладелец и администратор. В моем случае эти две роли совмещены.
Сценарий:
1. Домовладелец открывает рпиложение
2. Переходит у настройкам датчика
3. Выбирает температуру
4. Устанавливает настройки
5. Подтверждает изменения.


h3. Будильник и шторы
Будильник также настроен по расписанию, которое хранится в общем списке. Сделаем будильник срабатывающим на колонке. Также у будильника есть атрибут "мелодия" - что играет для данного времени. 

h4. Срабатывание будильника
Здесь важно одновременное выполнение событий: будильник начинает работать - шторы открываются.
1. Происходит проверка расписания
 * Если время совпадает с указанным, отправляем сигнал колонке и шторам
 * иначе продолжаем ждать сигнала
2. Если пользователь выключил будильник (голосом или через смартфон), шторы остаются в открытом состояни до сигнала
3. Если пришёл сигнал изменения состояния штор (открыть-закрыть), то выполняем. Работа с голосом и командами такая же, как и со светом

h4. Настройка будильника и штор.
Синхронизация расписания двух устройств может бвть настроена пользователем самостоятельно. 
Настройка расписания будильника та же, что и для остальных устройств.

